<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>SQLite + FullCalendar（保存/読込対応）</title>

    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>

    <!-- sql.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

    <style>
        body {
            font-family: sans-serif;
            padding: 2rem;
        }

        #calendar {
            max-width: 900px;
            margin: auto;
        }

        #controls {
            text-align: center;
            margin-bottom: 1rem;
        }

        button {
            margin: 0 0.5rem;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">SQLite + FullCalendar（保存/読込対応）</h1>
    <div id="controls">
        <button id="saveBtn">保存</button>
        <input type="file" id="loadInput" accept=".db" />
    </div>
    <div id="calendar"></div>

    <script>
        let db, calendar, SQL;

        const updateCalendarFromDB = () => {
            const res = db.exec("SELECT id, title, start, end FROM events");
            const events = res.length ? res[0].values.map(([id, title, start, end]) => ({ id, title, start, end })) : [];
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        };

        const initCalendar = () => {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                events: [],
                select: (info) => {
                    const title = prompt('イベントタイトル:');
                    if (title) {
                        db.run("INSERT INTO events (title, start, end) VALUES (?, ?, ?)", [title, info.startStr, info.endStr]);
                        updateCalendarFromDB();
                    }
                },
                eventClick: (info) => {
                    if (confirm(`"${info.event.title}" を削除しますか？`)) {
                        db.run("DELETE FROM events WHERE id = ?", [info.event.id]);
                        updateCalendarFromDB();
                    }
                }
            });
            calendar.render();
        };

        const initDatabase = () => {
            db = new SQL.Database();
            db.run(`CREATE TABLE IF NOT EXISTS events (
            id INTEGER PRIMARY KEY,
            title TEXT,
            start TEXT,
            end TEXT
          )`);
        };

        const setupUI = () => {
            document.getElementById('saveBtn').addEventListener('click', () => {
                const data = db.export();
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'calendar.db';
                a.click();
            });

            document.getElementById('loadInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const arrayBuffer = await file.arrayBuffer();
                db = new SQL.Database(new Uint8Array(arrayBuffer));
                updateCalendarFromDB();
            });
        };

        initSqlJs({
            locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}`
        }).then(SQLLib => {
            SQL = SQLLib;
            initDatabase();
            initCalendar();
            setupUI();
        });
    </script>
</body>
</html>
